# Docker Issue - Visual Breakdown

## ğŸ“Š The Dependency Chain

### What Happens When Backend Starts

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Docker Container: canton-backend                           â”‚
â”‚  Working Directory: /app                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  npm start             â”‚
              â”‚  â†’ node dist/server.js â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  dist/server.js loads...             â”‚
        â”‚  â€¢ dist/config.js                    â”‚
        â”‚  â€¢ dist/routes/contracts.js          â”‚
        â”‚  â€¢ dist/canton/ledger-client.js â† ğŸ’¥ â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  dist/canton/ledger-client.js (LINE 11):           â”‚
    â”‚                                                     â”‚
    â”‚  const Payment_1 = require(                        â”‚
    â”‚    "../daml-types/payment-demo-0.0.1/lib/Payment"  â”‚
    â”‚  );                                                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Node.js Module Lookup  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Resolving: "../daml-types/..."                  â”‚
    â”‚  From: /app/dist/canton/ledger-client.js         â”‚
    â”‚  Goes up: /app/dist/canton/ â†’ /app/dist/         â”‚
    â”‚  Target: /app/dist/daml-types/... âŒ NOT FOUND   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—‚ï¸ Directory Structure Comparison

### Local Dev (âœ… WORKS)

```
C:\Users\mbo1\viz\backend\
â”œâ”€â”€ node_modules/                    â† npm installed
â”‚   â”œâ”€â”€ @daml/ledger/
â”‚   â”œâ”€â”€ @daml/types/
â”‚   â”œâ”€â”€ express/
â”‚   â””â”€â”€ ... (all dependencies)
â”‚
â”œâ”€â”€ src/                             â† Source code
â”‚   â”œâ”€â”€ daml-types/                  â† Generated by daml codegen
â”‚   â”‚   â”œâ”€â”€ payment-demo-0.0.1/
â”‚   â”‚   â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ Payment/
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ index.js
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ module.js
â”‚   â”‚   â”‚   â”œâ”€â”€ node_modules/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ @daml.js/
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ d14e08.../ (SYMLINK â†’ ../../../d14e08.../)
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ @mojotech/
â”‚   â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ d14e08374fc7197d6a0de468c968ae8ba3aadbf9315476fd39071831f5923662/
â”‚   â”‚   â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”‚   â”œâ”€â”€ node_modules/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ @daml.js/
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ 40f452.../ (SYMLINK â†’ ../../../40f452.../)
â”‚   â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ 40f452260bef3f29dede136108fc08a88d5a5250310281067087da6f0baddff7/
â”‚   â”‚   â”‚   â””â”€â”€ ... (more nesting)
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ ... (26 more hash directories)
â”‚   â”‚
â”‚   â”œâ”€â”€ canton/
â”‚   â”‚   â””â”€â”€ ledger-client.ts  â† Imports '../daml-types/payment-demo-0.0.1/...'
â”‚   â””â”€â”€ server.ts
â”‚
â””â”€â”€ package.json

Execution: ts-node src/server.ts
Resolution: src/canton/ledger-client.ts â†’ ../daml-types â†’ src/daml-types âœ…
All symlinks work because everything is in original location!
```

---

### Docker Production (âŒ FAILS)

```
/app/                                â† Container root
â”œâ”€â”€ node_modules/                    â† Production dependencies only
â”‚   â”œâ”€â”€ @daml/ledger/                â† Installed by npm ci
â”‚   â”œâ”€â”€ @daml/types/
â”‚   â”œâ”€â”€ express/
â”‚   â””â”€â”€ ... (production deps)
â”‚
â”œâ”€â”€ dist/                            â† Compiled JavaScript
â”‚   â”œâ”€â”€ canton/
â”‚   â”‚   â””â”€â”€ ledger-client.js  â† ğŸ’¥ requires("../daml-types/...")
â”‚   â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ server.js
â”‚   â””â”€â”€ config.js
â”‚
â”œâ”€â”€ src/                             â† Copied from builder
â”‚   â””â”€â”€ daml-types/                  â† âš ï¸ Symlinks may be broken!
â”‚       â”œâ”€â”€ payment-demo-0.0.1/
â”‚       â”‚   â”œâ”€â”€ node_modules/
â”‚       â”‚   â”‚   â””â”€â”€ @daml.js/
â”‚       â”‚   â”‚       â””â”€â”€ d14e08.../ (SYMLINK â†’ ../../../d14e08.../)
â”‚       â”‚   â”‚                        â†‘ Does this work? Unknown!
â”‚       â”‚   â””â”€â”€ ...
â”‚       â””â”€â”€ d14e08.../
â”‚           â””â”€â”€ ...
â”‚
â””â”€â”€ package.json

Execution: node dist/server.js
Resolution: dist/canton/ledger-client.js â†’ ../daml-types â†’ dist/daml-types âŒ
Path doesn't exist! We copied to src/daml-types, not dist/daml-types!

Even if we copy to dist/daml-types:
- Symlinks may be broken during Docker copy
- Relative symlink targets might not resolve correctly
- Path issues compound
```

---

## ğŸ”— The Symlink Chain (Visual)

### Local Filesystem

```
payment-demo-0.0.1/package.json
â”‚
â”œâ”€ dependencies:
â”‚  â””â”€ "@daml.js/d14e08...": "file:../d14e08374fc7..."
â”‚
payment-demo-0.0.1/node_modules/@daml.js/d14e08.../
â”‚  (This is a SYMBOLIC LINK)
â”‚  Target: ../../../d14e08374fc7197d6a0de468c968ae8ba3aadbf9315476fd39071831f5923662/
â”‚  Resolves to: âœ… src/daml-types/d14e08.../
â”‚
d14e08.../package.json
â”‚
â”œâ”€ dependencies:
â”‚  â””â”€ "@daml.js/40f452...": "file:../40f452260bef..."
â”‚
d14e08.../node_modules/@daml.js/40f452.../
â”‚  (Another SYMBOLIC LINK)
â”‚  Target: ../../../40f452260bef3f29dede136108fc08a88d5a5250310281067087da6f0baddff7/
â”‚  Resolves to: âœ… src/daml-types/40f452.../
â”‚
... (continues for 6-8 levels deep)
```

### After Docker Copy

```
/app/src/daml-types/payment-demo-0.0.1/node_modules/@daml.js/d14e08.../
â”‚  (SYMLINK copied?)
â”‚  Target: ../../../d14e08374fc7197d6a0de468c968ae8ba3aadbf9315476fd39071831f5923662/
â”‚  Should resolve to: /app/src/daml-types/d14e08.../
â”‚
â”‚  âš ï¸ PROBLEMS:
â”‚  1. Windows Docker may not preserve symlinks correctly
â”‚  2. If it's a directory junction, it won't work in Linux container
â”‚  3. If Docker copied as regular directory, nested files may be missing
â”‚  4. Long paths during copy may have been truncated
```

---

## ğŸ”¢ Path Length Problem (Visual)

### Windows MAX_PATH Limit

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WINDOWS MAX_PATH = 260 CHARACTERS                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Example problematic path:
C:\Users\mbo1\viz\backend\src\daml-types\
041ddaabb3926f0b666d5e0a36bc1ae8dbf7191d2889afed5d1631af4172fa6b\
node_modules\@daml.js\
40f452260bef3f29dede136108fc08a88d5a5250310281067087da6f0baddff7\
node_modules\@mojotech\json-type-validation\dist\lib\combinators.js

Total length: 260 characters (EXACTLY at the limit!)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 0        50       100       150       200       250      260â”‚
â”‚ |--------|---------|---------|---------|---------|---------|â”‚
â”‚ C:\Users\mbo1\viz\backend\src\daml-types\041ddaabb3926...  â”‚
â”‚ ...f0b666d5e0a36bc1ae8dbf7191d2889afed5d1631af4172fa6b\...â”‚
â”‚ ...node_modules\@daml.js\40f452260bef3f29dede136108fc08a...â”‚
â”‚ ...88d5a5250310281067087da6f0baddff7\node_modules\@mojote...â”‚
â”‚ ...ch\json-type-validation\dist\lib\combinators.js         â”‚
â”‚                                                        â–²    â”‚
â”‚                                                    LIMIT    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Effects:
- PowerShell: "Cannot find item" error
- Windows Explorer: Cannot open folder
- Docker: Build context copy fails
- npm: May fail to install dependencies
```

---

## ğŸ—ï¸ Docker Multi-Stage Build (Visual)

### Stage 1: Builder (âœ… Works)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Builder Container (node:20-alpine)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  FROM node:20-alpine AS builder                      â”‚
â”‚  WORKDIR /app                                        â”‚
â”‚                                                      â”‚
â”‚  /app/                                               â”‚
â”‚  â”œâ”€â”€ node_modules/        â† npm ci (all deps)       â”‚
â”‚  â”œâ”€â”€ src/                 â† COPY src ./src          â”‚
â”‚  â”‚   â”œâ”€â”€ daml-types/      â† Includes all structure  â”‚
â”‚  â”‚   â”œâ”€â”€ canton/                                     â”‚
â”‚  â”‚   â””â”€â”€ server.ts                                   â”‚
â”‚  â””â”€â”€ package.json                                    â”‚
â”‚                                                      â”‚
â”‚  RUN npm run build  â†’ tsc compiles TypeScript       â”‚
â”‚                                                      â”‚
â”‚  /app/dist/ created:                                 â”‚
â”‚  â”œâ”€â”€ canton/                                         â”‚
â”‚  â”‚   â””â”€â”€ ledger-client.js  â† has require("../...")  â”‚
â”‚  â””â”€â”€ server.js                                       â”‚
â”‚                                                      â”‚
â”‚  âœ… TypeScript compilation succeeds!                â”‚
â”‚     (because node_modules has all @daml deps)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Stage 2: Production (âŒ Fails)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Production Container (node:20-alpine) - FRESH!      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  FROM node:20-alpine                                 â”‚
â”‚  WORKDIR /app                                        â”‚
â”‚                                                      â”‚
â”‚  COPY package*.json ./                               â”‚
â”‚  RUN npm ci --only=production                        â”‚
â”‚                                                      â”‚
â”‚  /app/                                               â”‚
â”‚  â”œâ”€â”€ node_modules/         â† Production deps only   â”‚
â”‚  â”‚   â”œâ”€â”€ express/                                    â”‚
â”‚  â”‚   â””â”€â”€ @daml/ledger/    â† Core deps exist         â”‚
â”‚  â”‚                                                   â”‚
â”‚  â””â”€â”€ package.json                                    â”‚
â”‚                                                      â”‚
â”‚  COPY --from=builder /app/dist ./dist                â”‚
â”‚                                                      â”‚
â”‚  /app/dist/               â† Compiled JS copied      â”‚
â”‚  â”œâ”€â”€ canton/                                         â”‚
â”‚  â”‚   â””â”€â”€ ledger-client.js â† ğŸ’¥ require("../daml...") â”‚
â”‚  â””â”€â”€ server.js                                       â”‚
â”‚                                                      â”‚
â”‚  COPY --from=builder /app/src/daml-types ./src/daml-types
â”‚                                                      â”‚
â”‚  /app/src/daml-types/     â† Types copied            â”‚
â”‚  â””â”€â”€ ... (but symlinks?)                             â”‚
â”‚                                                      â”‚
â”‚  CMD ["npm", "start"]  â†’ node dist/server.js        â”‚
â”‚                                                      â”‚
â”‚  ğŸ’¥ CRASH: Module not found                         â”‚
â”‚     â€¢ dist/canton/ledger-client.js                   â”‚
â”‚     â€¢ looks for ../daml-types                        â”‚
â”‚     â€¢ resolves to /app/dist/daml-types âŒ           â”‚
â”‚     â€¢ actual location: /app/src/daml-types           â”‚
â”‚     â€¢ mismatch!                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Module Resolution Algorithm

### Node.js Module Resolution for `require("../daml-types/payment-demo-0.0.1/lib/Payment")`

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: Determine Current Module Path                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Current file: /app/dist/canton/ledger-client.js             â”‚
â”‚ Directory:    /app/dist/canton/                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: Apply Relative Path                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Relative:  ../daml-types/payment-demo-0.0.1/lib/Payment     â”‚
â”‚ From:      /app/dist/canton/                                 â”‚
â”‚ Go up:     /app/dist/                                        â”‚
â”‚ Append:    daml-types/payment-demo-0.0.1/lib/Payment        â”‚
â”‚ Result:    /app/dist/daml-types/payment-demo-0.0.1/lib/Payment â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: Check if Path Exists                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Looking for: /app/dist/daml-types/                          â”‚
â”‚ Exists? âŒ NO                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: Try Loading from node_modules                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Check: /app/dist/canton/node_modules/daml-types/... âŒ      â”‚
â”‚ Check: /app/dist/node_modules/daml-types/... âŒ             â”‚
â”‚ Check: /app/node_modules/daml-types/... âŒ                  â”‚
â”‚ Check: /node_modules/daml-types/... âŒ                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 5: Throw Error                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Error: Cannot find module                                    â”‚
â”‚ '../daml-types/payment-demo-0.0.1/lib/Payment'              â”‚
â”‚                                                              â”‚
â”‚ ğŸ’¥ Container crashes and restarts                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Why Symlinks Make It Worse

### Symlink Resolution in Docker

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Windows Host                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ C:\Users\mbo1\viz\backend\src\daml-types\                 â”‚
â”‚ â”œâ”€â”€ payment-demo-0.0.1\node_modules\@daml.js\d14e08...\   â”‚
â”‚ â”‚   â”‚                                                      â”‚
â”‚ â”‚   â””â”€â”€(SYMLINK TYPE: Windows Junction or Symlink)        â”‚
â”‚ â”‚      TARGET: ..\..\..\d14e08374fc7...\                  â”‚
â”‚ â”‚                                                          â”‚
â”‚ â””â”€â”€ d14e08374fc7197d6a0de468c968ae8ba3aadbf9315476fd...\  â”‚
â”‚     â””â”€â”€ (actual files here)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    Docker Build Context
                    (COPY src ./src)
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Linux Container                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ /app/src/daml-types/                                       â”‚
â”‚ â”œâ”€â”€ payment-demo-0.0.1/node_modules/@daml.js/d14e08.../   â”‚
â”‚ â”‚   â”‚                                                      â”‚
â”‚ â”‚   â””â”€â”€(WHAT IS THIS NOW?)                                â”‚
â”‚ â”‚      Options:                                            â”‚
â”‚ â”‚      A) Regular directory (symlink followed) âœ… GOOD    â”‚
â”‚ â”‚      B) Broken symlink âŒ BAD                           â”‚
â”‚ â”‚      C) Empty directory âŒ BAD                          â”‚
â”‚ â”‚      D) Linux symlink (works!) âœ… GOOD                  â”‚
â”‚ â”‚                                                          â”‚
â”‚ â”‚      Result: UNPREDICTABLE! ğŸ²                          â”‚
â”‚ â”‚                                                          â”‚
â”‚ â””â”€â”€ d14e08374fc7197d6a0de468c968ae8ba3aadbf9315476fd...\  â”‚
â”‚     â””â”€â”€ (may or may not exist)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**The Problem:**
- Windows uses **NTFS junctions** or **symlinks**
- Docker for Windows tries to convert these during copy
- Linux containers expect **Linux symlinks**
- The conversion may fail or produce broken links
- Even if link exists, target may not (due to path length issues during copy)

---

## ğŸ“Š File Count Breakdown

```
Total daml-types Structure:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Files:       1,324                      â”‚
â”‚ Directories:   325                      â”‚
â”‚ Size:        ~45 MB (with node_modules) â”‚
â”‚              ~15 MB (without)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Breakdown:
â”œâ”€ payment-demo-0.0.1/  (~50 files)
â”œâ”€ Hash directories (28 total):
â”‚  â”œâ”€ 01adbfd23cec.../ (~40 files each)
â”‚  â”œâ”€ 041ddaabb3926.../ (~40 files each)
â”‚  â”œâ”€ 057eed1fd48c.../ (~40 files each)
â”‚  â””â”€ ... (25 more)
â”‚
â””â”€ Nested node_modules (variable):
   â”œâ”€ payment-demo/node_modules/ (~200 files)
   â”œâ”€ d14e08.../node_modules/ (~150 files)
   â””â”€ ... (cascading dependencies)

Problem Files (paths > 250 chars):
â”œâ”€ ~50 files hit MAX_PATH
â”œâ”€ ~30 files exceed MAX_PATH
â””â”€ ~10 files PowerShell can't even read
```

---

## ğŸ­ The Perfect Storm (Summary Visual)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    THE PERFECT STORM                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                                 â”‚
          â–¼                                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Daml    â”‚                      â”‚ Windows  â”‚
    â”‚ Design   â”‚                      â”‚ Limits   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                                 â”‚
    â”‚ â€¢ Hash dirs                     â”‚ â€¢ MAX_PATH
    â”‚ â€¢ Symlinks                      â”‚   (260 char)
    â”‚ â€¢ file: deps                    â”‚ â€¢ Symlink
    â”‚ â€¢ Deep nesting                  â”‚   issues
    â”‚                                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚  Docker  â”‚
       â”‚  on      â”‚
       â”‚  Windows â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ â€¢ Build context copy fails
             â”‚ â€¢ Symlinks may break
             â”‚ â€¢ Multi-stage = split env
             â”‚ â€¢ Long paths in transfer
             â”‚
             â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚  Node.js â”‚
       â”‚ Module   â”‚
       â”‚Resolutionâ”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ â€¢ Needs exact paths
             â”‚ â€¢ Follows symlinks
             â”‚ â€¢ require() is strict
             â”‚ â€¢ No fuzzy matching
             â”‚
             â–¼
        ğŸ’¥ CRASH ğŸ’¥
```

---

## âœ… Why Railway Might Work

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               WINDOWS (Current - Fails)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ MAX_PATH = 260 characters âŒ                           â”‚
â”‚ â€¢ NTFS junctions/symlinks (incompatible) âŒ              â”‚
â”‚ â€¢ Docker for Windows (translation layer) âŒ              â”‚
â”‚ â€¢ Long paths fail during build context transfer âŒ       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ Push to GitHub
                           â”‚ Deploy to Railway
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               LINUX (Railway - Might Work)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ MAX_PATH = 4096 characters âœ…                          â”‚
â”‚ â€¢ Native Linux symlinks âœ…                               â”‚
â”‚ â€¢ Native Docker (no translation) âœ…                      â”‚
â”‚ â€¢ Long paths work fine âœ…                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Chance of Success: 70%
```

---

**Created:** October 20, 2025  
**Purpose:** Visual explanation of Docker build issues



