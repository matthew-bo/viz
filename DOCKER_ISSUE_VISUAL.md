# Docker Issue - Visual Breakdown

## 📊 The Dependency Chain

### What Happens When Backend Starts

```
┌─────────────────────────────────────────────────────────────┐
│  Docker Container: canton-backend                           │
│  Working Directory: /app                                    │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
              ┌────────────────────────┐
              │  npm start             │
              │  → node dist/server.js │
              └────────────────────────┘
                           │
                           ▼
        ┌──────────────────────────────────────┐
        │  dist/server.js loads...             │
        │  • dist/config.js                    │
        │  • dist/routes/contracts.js          │
        │  • dist/canton/ledger-client.js ← 💥 │
        └──────────────────────────────────────┘
                           │
                           ▼
    ┌────────────────────────────────────────────────────┐
    │  dist/canton/ledger-client.js (LINE 11):           │
    │                                                     │
    │  const Payment_1 = require(                        │
    │    "../daml-types/payment-demo-0.0.1/lib/Payment"  │
    │  );                                                 │
    └────────────────────────────────────────────────────┘
                           │
                           ▼
              ┌─────────────────────────┐
              │  Node.js Module Lookup  │
              └─────────────────────────┘
                           │
                           ▼
    ┌──────────────────────────────────────────────────┐
    │  Resolving: "../daml-types/..."                  │
    │  From: /app/dist/canton/ledger-client.js         │
    │  Goes up: /app/dist/canton/ → /app/dist/         │
    │  Target: /app/dist/daml-types/... ❌ NOT FOUND   │
    └──────────────────────────────────────────────────┘
```

---

## 🗂️ Directory Structure Comparison

### Local Dev (✅ WORKS)

```
C:\Users\mbo1\viz\backend\
├── node_modules/                    ← npm installed
│   ├── @daml/ledger/
│   ├── @daml/types/
│   ├── express/
│   └── ... (all dependencies)
│
├── src/                             ← Source code
│   ├── daml-types/                  ← Generated by daml codegen
│   │   ├── payment-demo-0.0.1/
│   │   │   ├── lib/
│   │   │   │   └── Payment/
│   │   │   │       ├── index.js
│   │   │   │       └── module.js
│   │   │   ├── node_modules/
│   │   │   │   ├── @daml.js/
│   │   │   │   │   └── d14e08.../ (SYMLINK → ../../../d14e08.../)
│   │   │   │   └── @mojotech/
│   │   │   └── package.json
│   │   │
│   │   ├── d14e08374fc7197d6a0de468c968ae8ba3aadbf9315476fd39071831f5923662/
│   │   │   ├── lib/
│   │   │   ├── node_modules/
│   │   │   │   └── @daml.js/
│   │   │   │       └── 40f452.../ (SYMLINK → ../../../40f452.../)
│   │   │   └── package.json
│   │   │
│   │   ├── 40f452260bef3f29dede136108fc08a88d5a5250310281067087da6f0baddff7/
│   │   │   └── ... (more nesting)
│   │   │
│   │   └── ... (26 more hash directories)
│   │
│   ├── canton/
│   │   └── ledger-client.ts  ← Imports '../daml-types/payment-demo-0.0.1/...'
│   └── server.ts
│
└── package.json

Execution: ts-node src/server.ts
Resolution: src/canton/ledger-client.ts → ../daml-types → src/daml-types ✅
All symlinks work because everything is in original location!
```

---

### Docker Production (❌ FAILS)

```
/app/                                ← Container root
├── node_modules/                    ← Production dependencies only
│   ├── @daml/ledger/                ← Installed by npm ci
│   ├── @daml/types/
│   ├── express/
│   └── ... (production deps)
│
├── dist/                            ← Compiled JavaScript
│   ├── canton/
│   │   └── ledger-client.js  ← 💥 requires("../daml-types/...")
│   ├── routes/
│   ├── server.js
│   └── config.js
│
├── src/                             ← Copied from builder
│   └── daml-types/                  ← ⚠️ Symlinks may be broken!
│       ├── payment-demo-0.0.1/
│       │   ├── node_modules/
│       │   │   └── @daml.js/
│       │   │       └── d14e08.../ (SYMLINK → ../../../d14e08.../)
│       │   │                        ↑ Does this work? Unknown!
│       │   └── ...
│       └── d14e08.../
│           └── ...
│
└── package.json

Execution: node dist/server.js
Resolution: dist/canton/ledger-client.js → ../daml-types → dist/daml-types ❌
Path doesn't exist! We copied to src/daml-types, not dist/daml-types!

Even if we copy to dist/daml-types:
- Symlinks may be broken during Docker copy
- Relative symlink targets might not resolve correctly
- Path issues compound
```

---

## 🔗 The Symlink Chain (Visual)

### Local Filesystem

```
payment-demo-0.0.1/package.json
│
├─ dependencies:
│  └─ "@daml.js/d14e08...": "file:../d14e08374fc7..."
│
payment-demo-0.0.1/node_modules/@daml.js/d14e08.../
│  (This is a SYMBOLIC LINK)
│  Target: ../../../d14e08374fc7197d6a0de468c968ae8ba3aadbf9315476fd39071831f5923662/
│  Resolves to: ✅ src/daml-types/d14e08.../
│
d14e08.../package.json
│
├─ dependencies:
│  └─ "@daml.js/40f452...": "file:../40f452260bef..."
│
d14e08.../node_modules/@daml.js/40f452.../
│  (Another SYMBOLIC LINK)
│  Target: ../../../40f452260bef3f29dede136108fc08a88d5a5250310281067087da6f0baddff7/
│  Resolves to: ✅ src/daml-types/40f452.../
│
... (continues for 6-8 levels deep)
```

### After Docker Copy

```
/app/src/daml-types/payment-demo-0.0.1/node_modules/@daml.js/d14e08.../
│  (SYMLINK copied?)
│  Target: ../../../d14e08374fc7197d6a0de468c968ae8ba3aadbf9315476fd39071831f5923662/
│  Should resolve to: /app/src/daml-types/d14e08.../
│
│  ⚠️ PROBLEMS:
│  1. Windows Docker may not preserve symlinks correctly
│  2. If it's a directory junction, it won't work in Linux container
│  3. If Docker copied as regular directory, nested files may be missing
│  4. Long paths during copy may have been truncated
```

---

## 🔢 Path Length Problem (Visual)

### Windows MAX_PATH Limit

```
┌───────────────────────────────────────────────────────────────┐
│  WINDOWS MAX_PATH = 260 CHARACTERS                            │
└───────────────────────────────────────────────────────────────┘

Example problematic path:
C:\Users\mbo1\viz\backend\src\daml-types\
041ddaabb3926f0b666d5e0a36bc1ae8dbf7191d2889afed5d1631af4172fa6b\
node_modules\@daml.js\
40f452260bef3f29dede136108fc08a88d5a5250310281067087da6f0baddff7\
node_modules\@mojotech\json-type-validation\dist\lib\combinators.js

Total length: 260 characters (EXACTLY at the limit!)

┌─────────────────────────────────────────────────────────────┐
│ 0        50       100       150       200       250      260│
│ |--------|---------|---------|---------|---------|---------|│
│ C:\Users\mbo1\viz\backend\src\daml-types\041ddaabb3926...  │
│ ...f0b666d5e0a36bc1ae8dbf7191d2889afed5d1631af4172fa6b\...│
│ ...node_modules\@daml.js\40f452260bef3f29dede136108fc08a...│
│ ...88d5a5250310281067087da6f0baddff7\node_modules\@mojote...│
│ ...ch\json-type-validation\dist\lib\combinators.js         │
│                                                        ▲    │
│                                                    LIMIT    │
└─────────────────────────────────────────────────────────────┘

Effects:
- PowerShell: "Cannot find item" error
- Windows Explorer: Cannot open folder
- Docker: Build context copy fails
- npm: May fail to install dependencies
```

---

## 🏗️ Docker Multi-Stage Build (Visual)

### Stage 1: Builder (✅ Works)

```
┌──────────────────────────────────────────────────────┐
│  Builder Container (node:20-alpine)                  │
├──────────────────────────────────────────────────────┤
│  FROM node:20-alpine AS builder                      │
│  WORKDIR /app                                        │
│                                                      │
│  /app/                                               │
│  ├── node_modules/        ← npm ci (all deps)       │
│  ├── src/                 ← COPY src ./src          │
│  │   ├── daml-types/      ← Includes all structure  │
│  │   ├── canton/                                     │
│  │   └── server.ts                                   │
│  └── package.json                                    │
│                                                      │
│  RUN npm run build  → tsc compiles TypeScript       │
│                                                      │
│  /app/dist/ created:                                 │
│  ├── canton/                                         │
│  │   └── ledger-client.js  ← has require("../...")  │
│  └── server.js                                       │
│                                                      │
│  ✅ TypeScript compilation succeeds!                │
│     (because node_modules has all @daml deps)       │
└──────────────────────────────────────────────────────┘
```

---

### Stage 2: Production (❌ Fails)

```
┌──────────────────────────────────────────────────────┐
│  Production Container (node:20-alpine) - FRESH!      │
├──────────────────────────────────────────────────────┤
│  FROM node:20-alpine                                 │
│  WORKDIR /app                                        │
│                                                      │
│  COPY package*.json ./                               │
│  RUN npm ci --only=production                        │
│                                                      │
│  /app/                                               │
│  ├── node_modules/         ← Production deps only   │
│  │   ├── express/                                    │
│  │   └── @daml/ledger/    ← Core deps exist         │
│  │                                                   │
│  └── package.json                                    │
│                                                      │
│  COPY --from=builder /app/dist ./dist                │
│                                                      │
│  /app/dist/               ← Compiled JS copied      │
│  ├── canton/                                         │
│  │   └── ledger-client.js ← 💥 require("../daml...") │
│  └── server.js                                       │
│                                                      │
│  COPY --from=builder /app/src/daml-types ./src/daml-types
│                                                      │
│  /app/src/daml-types/     ← Types copied            │
│  └── ... (but symlinks?)                             │
│                                                      │
│  CMD ["npm", "start"]  → node dist/server.js        │
│                                                      │
│  💥 CRASH: Module not found                         │
│     • dist/canton/ledger-client.js                   │
│     • looks for ../daml-types                        │
│     • resolves to /app/dist/daml-types ❌           │
│     • actual location: /app/src/daml-types           │
│     • mismatch!                                      │
└──────────────────────────────────────────────────────┘
```

---

## 🔄 Module Resolution Algorithm

### Node.js Module Resolution for `require("../daml-types/payment-demo-0.0.1/lib/Payment")`

```
┌──────────────────────────────────────────────────────────────┐
│ Step 1: Determine Current Module Path                       │
├──────────────────────────────────────────────────────────────┤
│ Current file: /app/dist/canton/ledger-client.js             │
│ Directory:    /app/dist/canton/                              │
└──────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌──────────────────────────────────────────────────────────────┐
│ Step 2: Apply Relative Path                                 │
├──────────────────────────────────────────────────────────────┤
│ Relative:  ../daml-types/payment-demo-0.0.1/lib/Payment     │
│ From:      /app/dist/canton/                                 │
│ Go up:     /app/dist/                                        │
│ Append:    daml-types/payment-demo-0.0.1/lib/Payment        │
│ Result:    /app/dist/daml-types/payment-demo-0.0.1/lib/Payment │
└──────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌──────────────────────────────────────────────────────────────┐
│ Step 3: Check if Path Exists                                │
├──────────────────────────────────────────────────────────────┤
│ Looking for: /app/dist/daml-types/                          │
│ Exists? ❌ NO                                                │
└──────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌──────────────────────────────────────────────────────────────┐
│ Step 4: Try Loading from node_modules                       │
├──────────────────────────────────────────────────────────────┤
│ Check: /app/dist/canton/node_modules/daml-types/... ❌      │
│ Check: /app/dist/node_modules/daml-types/... ❌             │
│ Check: /app/node_modules/daml-types/... ❌                  │
│ Check: /node_modules/daml-types/... ❌                      │
└──────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌──────────────────────────────────────────────────────────────┐
│ Step 5: Throw Error                                         │
├──────────────────────────────────────────────────────────────┤
│ Error: Cannot find module                                    │
│ '../daml-types/payment-demo-0.0.1/lib/Payment'              │
│                                                              │
│ 💥 Container crashes and restarts                           │
└──────────────────────────────────────────────────────────────┘
```

---

## 🎯 Why Symlinks Make It Worse

### Symlink Resolution in Docker

```
┌────────────────────────────────────────────────────────────┐
│ Windows Host                                               │
├────────────────────────────────────────────────────────────┤
│ C:\Users\mbo1\viz\backend\src\daml-types\                 │
│ ├── payment-demo-0.0.1\node_modules\@daml.js\d14e08...\   │
│ │   │                                                      │
│ │   └──(SYMLINK TYPE: Windows Junction or Symlink)        │
│ │      TARGET: ..\..\..\d14e08374fc7...\                  │
│ │                                                          │
│ └── d14e08374fc7197d6a0de468c968ae8ba3aadbf9315476fd...\  │
│     └── (actual files here)                                │
└────────────────────────────────────────────────────────────┘
                           │
                    Docker Build Context
                    (COPY src ./src)
                           │
                           ▼
┌────────────────────────────────────────────────────────────┐
│ Linux Container                                            │
├────────────────────────────────────────────────────────────┤
│ /app/src/daml-types/                                       │
│ ├── payment-demo-0.0.1/node_modules/@daml.js/d14e08.../   │
│ │   │                                                      │
│ │   └──(WHAT IS THIS NOW?)                                │
│ │      Options:                                            │
│ │      A) Regular directory (symlink followed) ✅ GOOD    │
│ │      B) Broken symlink ❌ BAD                           │
│ │      C) Empty directory ❌ BAD                          │
│ │      D) Linux symlink (works!) ✅ GOOD                  │
│ │                                                          │
│ │      Result: UNPREDICTABLE! 🎲                          │
│ │                                                          │
│ └── d14e08374fc7197d6a0de468c968ae8ba3aadbf9315476fd...\  │
│     └── (may or may not exist)                             │
└────────────────────────────────────────────────────────────┘
```

**The Problem:**
- Windows uses **NTFS junctions** or **symlinks**
- Docker for Windows tries to convert these during copy
- Linux containers expect **Linux symlinks**
- The conversion may fail or produce broken links
- Even if link exists, target may not (due to path length issues during copy)

---

## 📊 File Count Breakdown

```
Total daml-types Structure:
┌─────────────────────────────────────────┐
│ Files:       1,324                      │
│ Directories:   325                      │
│ Size:        ~45 MB (with node_modules) │
│              ~15 MB (without)           │
└─────────────────────────────────────────┘

Breakdown:
├─ payment-demo-0.0.1/  (~50 files)
├─ Hash directories (28 total):
│  ├─ 01adbfd23cec.../ (~40 files each)
│  ├─ 041ddaabb3926.../ (~40 files each)
│  ├─ 057eed1fd48c.../ (~40 files each)
│  └─ ... (25 more)
│
└─ Nested node_modules (variable):
   ├─ payment-demo/node_modules/ (~200 files)
   ├─ d14e08.../node_modules/ (~150 files)
   └─ ... (cascading dependencies)

Problem Files (paths > 250 chars):
├─ ~50 files hit MAX_PATH
├─ ~30 files exceed MAX_PATH
└─ ~10 files PowerShell can't even read
```

---

## 🎭 The Perfect Storm (Summary Visual)

```
┌────────────────────────────────────────────────────────────┐
│                    THE PERFECT STORM                       │
└────────────────────────────────────────────────────────────┘
                           │
          ┌────────────────┴────────────────┐
          │                                 │
          ▼                                 ▼
    ┌──────────┐                      ┌──────────┐
    │  Daml    │                      │ Windows  │
    │ Design   │                      │ Limits   │
    └──────────┘                      └──────────┘
    │                                 │
    │ • Hash dirs                     │ • MAX_PATH
    │ • Symlinks                      │   (260 char)
    │ • file: deps                    │ • Symlink
    │ • Deep nesting                  │   issues
    │                                 │
    └────────┬────────────────────────┘
             │
             ▼
       ┌──────────┐
       │  Docker  │
       │  on      │
       │  Windows │
       └──────────┘
             │
             │ • Build context copy fails
             │ • Symlinks may break
             │ • Multi-stage = split env
             │ • Long paths in transfer
             │
             ▼
       ┌──────────┐
       │  Node.js │
       │ Module   │
       │Resolution│
       └──────────┘
             │
             │ • Needs exact paths
             │ • Follows symlinks
             │ • require() is strict
             │ • No fuzzy matching
             │
             ▼
        💥 CRASH 💥
```

---

## ✅ Why Railway Might Work

```
┌──────────────────────────────────────────────────────────┐
│               WINDOWS (Current - Fails)                  │
├──────────────────────────────────────────────────────────┤
│ • MAX_PATH = 260 characters ❌                           │
│ • NTFS junctions/symlinks (incompatible) ❌              │
│ • Docker for Windows (translation layer) ❌              │
│ • Long paths fail during build context transfer ❌       │
└──────────────────────────────────────────────────────────┘
                           │
                           │ Push to GitHub
                           │ Deploy to Railway
                           ▼
┌──────────────────────────────────────────────────────────┐
│               LINUX (Railway - Might Work)               │
├──────────────────────────────────────────────────────────┤
│ • MAX_PATH = 4096 characters ✅                          │
│ • Native Linux symlinks ✅                               │
│ • Native Docker (no translation) ✅                      │
│ • Long paths work fine ✅                                │
└──────────────────────────────────────────────────────────┘

Chance of Success: 70%
```

---

**Created:** October 20, 2025  
**Purpose:** Visual explanation of Docker build issues



